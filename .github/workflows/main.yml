name: CI/CD for Web Server

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16' # Ganti dengan versi Node.js yang Anda inginkan

      - name: Create simple web server
        run: |
          echo "const http = require('http');" > server.js
          echo "const hostname = '0.0.0.0';" >> server.js
          echo "const port = 3000;" >> server.js
          echo "const server = http.createServer((req, res) => {" >> server.js
          echo "    res.statusCode = 200;" >> server.js
          echo "    res.setHeader('Content-Type', 'text/plain');" >> server.js
          echo "    res.end('Hello World\\n');" >> server.js
          echo "});" >> server.js
          echo "server.listen(port, hostname, () => {" >> server.js
          echo "    console.log(\`Server running at http://\${hostname}:\${port}/\`);" >> server.js
          echo "});" >> server.js

      - name: Start the web server
        run: |
          nohup node server.js &
          sleep 5 # Tunggu server untuk mulai

      - name: Install Cloudflare Tunnel
        run: |
          sudo apt-get update
          sudo apt-get install -y cloudflared

      - name: Authenticate Cloudflare Tunnel
        run: |
          echo "${{ secrets.CLOUDFLARE_TOKEN }}" | cloudflared tunnel login

      - name: Run Cloudflare Tunnel
        run: |
          cloudflared tunnel --url http://localhost:3000 --no-autoupdate --loglevel info
