name: Deploy to Cloudflare Tunnel

on:
  push:
    branches:
      - main  # Ganti dengan nama cabang yang sesuai jika perlu

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Install Apache2
      run: |
        sudo apt update
        sudo apt install -y apache2

    - name: Start Apache2
      run: |
        sudo systemctl start apache2
        sudo systemctl enable apache2

    - name: Install Cloudflare Tunnel (cloudflared)
      run: |
        sudo apt install -y wget
        wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared
        sudo chmod +x /usr/local/bin/cloudflared

    - name: Setup Cloudflare Tunnel
      run: |
        echo "${{ secrets.cert.pem }}" > cert.pem
        sudo cloudflared tunnel run demo --cert cert.pem
      env:
        CLOUDFLARE_TOKEN: ${{ secrets.CLOUDFLARE_TOKEN }}
