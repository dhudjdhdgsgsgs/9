name: Ubuntu ttyd
on: workflow_dispatch

jobs:
  run-terminal:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install ttyd
        run: |
          sudo apt update
          sudo apt install ttyd

      - name: Install Cloudflared
        run: |
          # Download dan install cloudflared versi terbaru
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb
          rm cloudflared.deb

      - name: Start ttyd
        run: |
          nohup ttyd -p 8080 -c user:Root123 bash &
          echo "Menunggu ttyd siap..."
          sleep 5
          
      - name: Verify ttyd
        run: |
          if curl -s http://localhost:8080 > /dev/null; then
            echo "✅ ttyd berjalan dengan baik di port 8080"
          else
            echo "❌ ttyd tidak berjalan"
            exit 1
          fi

      - name: Start and Verify Cloudflare Tunnel
        env:
          TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
        run: |
          # Jalankan tunnel dengan token
          echo "🚀 Memulai Cloudflare tunnel..."
          nohup cloudflared service install ${TUNNEL_TOKEN} &
          sleep 5
          
          # Start tunnel service
          sudo systemctl start cloudflared
          sleep 10
          
          # Cek status tunnel
          echo "🔍 Memeriksa status tunnel..."
          if sudo systemctl is-active cloudflared; then
            echo "✅ Tunnel service aktif"
          else
            echo "❌ Tunnel service tidak aktif"
            sudo systemctl status cloudflared
            exit 1
          fi
          
          # Tampilkan log tunnel
          echo "📋 Log tunnel terakhir:"
          sudo journalctl -u cloudflared -n 50 --no-pager
          
          # Cek koneksi tunnel
          echo "🌐 Memeriksa koneksi tunnel..."
          if cloudflared tunnel info; then
            echo "✅ Tunnel terhubung"
          else
            echo "❌ Tunnel tidak terhubung"
            exit 1
          fi

      - name: Keep alive
        run: |
          while true; do
            echo "🔄 Memeriksa status layanan..."
            if ! sudo systemctl is-active cloudflared > /dev/null; then
              echo "🔄 Mencoba restart tunnel..."
              sudo systemctl restart cloudflared
            fi
            if ! curl -s http://localhost:8080 > /dev/null; then
              echo "🔄 Mencoba restart ttyd..."
              nohup ttyd -p 8080 -c user:Root123 bash &
            fi
            sleep 60
          done
