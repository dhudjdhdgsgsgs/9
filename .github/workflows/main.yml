name: Deploy Apache with Cloudflare Tunnel

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Check out the repository
        uses: actions/checkout@v3

      - name: Install Apache
        run: |
          sudo apt update
          sudo apt install -y apache2

      - name: Enable and start Apache
        run: |
          sudo systemctl enable apache2
          sudo systemctl start apache2

      - name: Install Cloudflare Tunnel (cloudflared)
        run: |
          sudo apt-get install -y wget
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Authenticate with Cloudflare and Configure Tunnel
        env:
          CLOUDFLARE_TOKEN: ${{ secrets.CLOUDFLARE_TOKEN }}
        run: |
          mkdir -p ~/.cloudflared
          echo $CLOUDFLARE_TOKEN | cloudflared tunnel login
          echo "tunnel: 7d92c3d4-daea-488e-bd1f-a78c6c673adf" > ~/.cloudflared/config.yml
          echo "credentials-file: /home/runner/.cloudflared/7d92c3d4-daea-488e-bd1f-a78c6c673adf.json" >> ~/.cloudflared/config.yml
          echo "ingress:" >> ~/.cloudflared/config.yml
          echo "  - hostname: demo.andik252.biz.id" >> ~/.cloudflared/config.yml
          echo "    service: http://localhost:80" >> ~/.cloudflared/config.yml
          echo "  - service: http_status:404" >> ~/.cloudflared/config.yml

      - name: Start Cloudflare Tunnel
        env:
          CLOUDFLARE_TOKEN: ${{ secrets.CLOUDFLARE_TOKEN }}
        run: |
          cloudflared tunnel run 7d92c3d4-daea-488e-bd1f-a78c6c673adf
