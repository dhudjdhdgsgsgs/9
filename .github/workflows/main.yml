name: Web Server with Cloudflared Custom Domain

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  setup-and-tunnel:
    runs-on: ubuntu-latest
    
    env:
      TUNNEL_NAME: my-github-tunnel  # Nama tunnel Anda
      TUNNEL_SUBDOMAIN: myapp        # Subdomain yang diinginkan
      DOMAIN: example.com            # Domain Cloudflare Anda
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          
      - name: Create simple web server file
        run: |
          echo '
          from http.server import HTTPServer, SimpleHTTPRequestHandler
          import socket
          
          class Handler(SimpleHTTPRequestHandler):
              def do_GET(self):
                  self.send_response(200)
                  self.send_header("Content-type", "text/html")
                  self.end_headers()
                  self.wfile.write(b"Hello, World!")
          
          httpd = HTTPServer(("", 8000), Handler)
          print("Server running at http://localhost:8000")
          httpd.serve_forever()
          ' > server.py
          
      - name: Install cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb
          
      - name: Authenticate cloudflared
        run: |
          echo "${{ secrets.CLOUDFLARE_CERT }}" > ~/.cloudflared/cert.pem
          
      - name: Create tunnel configuration
        run: |
          mkdir -p ~/.cloudflared
          echo "
          tunnel: ${{ env.TUNNEL_NAME }}
          credentials-file: /home/runner/.cloudflared/credentials.json
          
          ingress:
            - hostname: ${{ env.TUNNEL_SUBDOMAIN }}.${{ env.DOMAIN }}
              service: http://localhost:8000
            - service: http_status:404
          " > ~/.cloudflared/config.yml
          
      - name: Start web server
        run: python server.py &
        
      - name: Create and run tunnel
        run: |
          cloudflared tunnel login
          cloudflared tunnel create ${{ env.TUNNEL_NAME }}
          cloudflared tunnel route dns ${{ env.TUNNEL_NAME }} ${{ env.TUNNEL_SUBDOMAIN }}.${{ env.DOMAIN }}
          cloudflared tunnel run ${{ env.TUNNEL_NAME }}
        env:
          TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
